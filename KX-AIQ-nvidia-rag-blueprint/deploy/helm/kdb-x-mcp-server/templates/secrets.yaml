{{/*
Image Pull Secret for private registries (MCP server)
*/}}
{{- if and (eq .Values.mode "internal") .Values.imagePullSecret.create }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Values.imagePullSecret.name }}
  labels:
    {{- include "kdb-x-mcp-server.labels" . | nindent 4 }}
type: kubernetes.io/dockerconfigjson
data:
  .dockerconfigjson: {{ printf "{\"auths\":{\"%s\":{\"username\":\"%s\",\"password\":\"%s\",\"auth\":\"%s\"}}}" .Values.imagePullSecret.registry .Values.imagePullSecret.username .Values.imagePullSecret.password (printf "%s:%s" .Values.imagePullSecret.username .Values.imagePullSecret.password | b64enc) | b64enc | quote }}
---
{{- end }}
{{/*
Image Pull Secret for KX registry (KDB-X database)
*/}}
{{- if and (eq .Values.mode "internal") .Values.kdbx.enabled .Values.kdbx.imagePullSecret.create }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Values.kdbx.imagePullSecret.name }}
  labels:
    {{- include "kdb-x-mcp-server.labels" . | nindent 4 }}
type: kubernetes.io/dockerconfigjson
data:
  .dockerconfigjson: {{ printf "{\"auths\":{\"%s\":{\"username\":\"%s\",\"password\":\"%s\",\"auth\":\"%s\"}}}" .Values.kdbx.imagePullSecret.registry .Values.kdbx.imagePullSecret.username .Values.kdbx.imagePullSecret.password (printf "%s:%s" .Values.kdbx.imagePullSecret.username .Values.kdbx.imagePullSecret.password | b64enc) | b64enc | quote }}
---
{{- end }}
{{/*
Secrets for internal mode (KDB database credentials)
*/}}
{{- if and (eq .Values.mode "internal") .Values.dbSecret.create }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Values.dbSecret.name }}
  labels:
    {{- include "kdb-x-mcp-server.labels" . | nindent 4 }}
type: Opaque
data:
  username: {{ .Values.database.username | b64enc | quote }}
  password: {{ .Values.database.password | b64enc | quote }}
---
{{- end }}
{{/*
TLS Secret for internal mode
*/}}
{{- if and (eq .Values.mode "internal") .Values.tlsSecret.create }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Values.tlsSecret.name }}
  labels:
    {{- include "kdb-x-mcp-server.labels" . | nindent 4 }}
type: Opaque
data:
  ca.crt: {{ .Values.tlsSecret.caCert | quote }}
---
{{- end }}
{{/*
OpenAI API Key Secret (for embeddings, internal mode)
*/}}
{{- if and (eq .Values.mode "internal") .Values.openaiSecret.create }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Values.openaiSecret.name }}
  labels:
    {{- include "kdb-x-mcp-server.labels" . | nindent 4 }}
type: Opaque
data:
  api-key: {{ .Values.openaiSecret.apiKey | b64enc | quote }}
---
{{- end }}
{{/*
External MCP API Key Secret (for external mode)
*/}}
{{- if and (eq .Values.mode "external") .Values.external.apiKey }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "kdb-x-mcp-server.fullname" . }}-external-api
  labels:
    {{- include "kdb-x-mcp-server.labels" . | nindent 4 }}
type: Opaque
data:
  api-key: {{ .Values.external.apiKey | b64enc | quote }}
---
{{- end }}
{{/*
KDB License Secret (for PyKX licensing)
*/}}
{{- if and (eq .Values.mode "internal") .Values.kdbLicense.create .Values.kdbLicense.licenseB64 }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Values.kdbLicense.name }}
  labels:
    {{- include "kdb-x-mcp-server.labels" . | nindent 4 }}
type: Opaque
data:
  {{- if eq .Values.kdbLicense.type "personal" }}
  kc.lic: {{ .Values.kdbLicense.licenseB64 | quote }}
  {{- else }}
  k4.lic: {{ .Values.kdbLicense.licenseB64 | quote }}
  {{- end }}
---
{{- end }}
{{/*
KDB-X Runtime Installation Secret (for runtime mode)
Contains bearer token and license for installing KDB-X at container startup
*/}}
{{- if and (eq .Values.mode "internal") .Values.kdbx.enabled (eq .Values.kdbx.installMode "runtime") }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "kdb-x-mcp-server.fullname" . }}-kdbx-install
  labels:
    {{- include "kdb-x-mcp-server.labels" . | nindent 4 }}
type: Opaque
data:
  bearer-token: {{ .Values.kdbx.build.bearerToken | b64enc | quote }}
  license-b64: {{ .Values.kdbx.build.licenseB64 | b64enc | quote }}
{{- end }}
