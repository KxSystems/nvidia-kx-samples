# KX-NVIDIA RAG Blueprint - Docker Image Build & Push
#
# This workflow builds and pushes Docker images to the KX Downloads portal.
# Documentation: https://handbook.kxi-dev.kx.com/devops/tools/kx-downloads/kx-downloads.html
#
# IMPORTANT NOTES:
# - Artifacts are IMMUTABLE: once uploaded, they cannot be overwritten
# - Semantic Versioning is enforced by the registry
# - The 'latest' tag is server-side maintained and cannot be manually pushed
# - Test on dev.downloads.kx.com before pushing to production
#
# Support: #downloads-portal-help or download-portal-help@kx.com

name: Build and Push Docker Images

on:
  push:
    branches:
      - main
      - develop
    tags:
      # Semantic version tags only (enforced by KX Downloads)
      - 'v[0-9]+.[0-9]+.[0-9]+'
      - 'v[0-9]+.[0-9]+.[0-9]+-*'  # Prereleases like v1.2.3-rc.1
    paths:
      - 'KX-nvidia-rag-blueprint/src/**'
      - 'KX-nvidia-rag-blueprint/frontend/**'
      - 'KX-nvidia-rag-blueprint/pyproject.toml'
      - 'KX-nvidia-rag-blueprint/uv.lock'
      - '.github/workflows/docker-build.yml'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'KX-nvidia-rag-blueprint/src/**'
      - 'KX-nvidia-rag-blueprint/frontend/**'
      - 'KX-nvidia-rag-blueprint/pyproject.toml'
      - 'KX-nvidia-rag-blueprint/uv.lock'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment (test on dev first - artifacts are immutable!)'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod
      version:
        description: 'Semantic version (e.g., 2.3.0 or 2.3.0-rc.1). Required for push.'
        required: false
        type: string

env:
  # KX Downloads Portal registries
  PROD_REGISTRY: portal.dl.kx.com
  DEV_REGISTRY: dev.downloads.kx.com

  # Image names (will appear as portal.dl.kx.com/<image-name>:<version>)
  RAG_SERVER_IMAGE: rag-server-kdbai
  INGESTOR_SERVER_IMAGE: ingestor-server-kdbai
  FRONTEND_IMAGE: rag-frontend-kdbai

  # Working directory for the blueprint
  BLUEPRINT_DIR: KX-nvidia-rag-blueprint

jobs:
  # Determine build configuration
  setup:
    runs-on: ubuntu-latest
    outputs:
      registry: ${{ steps.config.outputs.registry }}
      environment: ${{ steps.config.outputs.environment }}
      version: ${{ steps.version.outputs.version }}
      push_images: ${{ steps.config.outputs.push_images }}
      is_prerelease: ${{ steps.version.outputs.is_prerelease }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine configuration
        id: config
        run: |
          # Determine environment and registry
          # - Tags and main branch -> production
          # - develop and feature branches -> development
          # - Manual dispatch -> user choice
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            ENV="${{ github.event.inputs.environment }}"
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            # Tags always go to production
            ENV="prod"
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            # Main branch -> production
            ENV="prod"
          else
            # develop, feature branches -> development
            ENV="dev"
          fi

          echo "Environment: $ENV"
          echo "environment=$ENV" >> $GITHUB_OUTPUT

          if [[ "$ENV" == "prod" ]]; then
            echo "registry=${{ env.PROD_REGISTRY }}" >> $GITHUB_OUTPUT
          else
            echo "registry=${{ env.DEV_REGISTRY }}" >> $GITHUB_OUTPUT
          fi

          # Only push on non-PR events
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "push_images=false" >> $GITHUB_OUTPUT
            echo "Will build but NOT push (pull request)"
          else
            echo "push_images=true" >> $GITHUB_OUTPUT
          fi

      - name: Determine version
        id: version
        working-directory: ${{ env.BLUEPRINT_DIR }}
        run: |
          # KX Downloads enforces Semantic Versioning
          # Format: MAJOR.MINOR.PATCH or MAJOR.MINOR.PATCH-prerelease+build

          if [[ -n "${{ github.event.inputs.version }}" ]]; then
            # Manual input - use as-is
            VERSION="${{ github.event.inputs.version }}"
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            # Git tag - strip the 'v' prefix for semver compliance
            VERSION="${{ github.ref_name }}"
            VERSION="${VERSION#v}"
          else
            # Generate prerelease version: BASE-dev.SHA
            # This ensures uniqueness while being semver compliant
            BASE_VERSION=$(grep -E '^version\s*=' pyproject.toml | sed 's/version = "\(.*\)"/\1/' | sed 's/\.dev$//')
            SHORT_SHA=$(git rev-parse --short HEAD)
            VERSION="${BASE_VERSION}-dev.${SHORT_SHA}"
          fi

          # Validate semver format (basic check)
          if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?(\+[a-zA-Z0-9.]+)?$ ]]; then
            echo "::error::Version '$VERSION' does not appear to be valid Semantic Versioning"
            echo "Expected format: MAJOR.MINOR.PATCH or MAJOR.MINOR.PATCH-prerelease"
            exit 1
          fi

          # Check if prerelease
          if [[ "$VERSION" == *-* ]]; then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
          fi

          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Building version: ${VERSION}"

  # Build RAG Server
  build-rag-server:
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to KX Downloads Registry (Dev)
        if: needs.setup.outputs.push_images == 'true' && needs.setup.outputs.environment == 'dev'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DEV_REGISTRY }}
          username: ${{ secrets.KX_DOWNLOADS_USER_DEV }}
          password: ${{ secrets.KX_DOWNLOADS_TOKEN_DEV }}

      - name: Login to KX Downloads Registry (Prod)
        if: needs.setup.outputs.push_images == 'true' && needs.setup.outputs.environment == 'prod'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.PROD_REGISTRY }}
          username: ${{ secrets.KX_DOWNLOADS_USER_PROD }}
          password: ${{ secrets.KX_DOWNLOADS_TOKEN_PROD }}

      - name: Build and push RAG Server
        uses: docker/build-push-action@v5
        with:
          context: ${{ env.BLUEPRINT_DIR }}
          file: ${{ env.BLUEPRINT_DIR }}/src/nvidia_rag/rag_server/Dockerfile
          push: ${{ needs.setup.outputs.push_images == 'true' }}
          # Note: 'latest' tag is server-side maintained by KX Downloads
          tags: ${{ needs.setup.outputs.registry }}/${{ env.RAG_SERVER_IMAGE }}:${{ needs.setup.outputs.version }}
          labels: |
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.version=${{ needs.setup.outputs.version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

  # Build Ingestor Server
  build-ingestor-server:
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to KX Downloads Registry (Dev)
        if: needs.setup.outputs.push_images == 'true' && needs.setup.outputs.environment == 'dev'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DEV_REGISTRY }}
          username: ${{ secrets.KX_DOWNLOADS_USER_DEV }}
          password: ${{ secrets.KX_DOWNLOADS_TOKEN_DEV }}

      - name: Login to KX Downloads Registry (Prod)
        if: needs.setup.outputs.push_images == 'true' && needs.setup.outputs.environment == 'prod'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.PROD_REGISTRY }}
          username: ${{ secrets.KX_DOWNLOADS_USER_PROD }}
          password: ${{ secrets.KX_DOWNLOADS_TOKEN_PROD }}

      - name: Build and push Ingestor Server
        uses: docker/build-push-action@v5
        with:
          context: ${{ env.BLUEPRINT_DIR }}
          file: ${{ env.BLUEPRINT_DIR }}/src/nvidia_rag/ingestor_server/Dockerfile
          push: ${{ needs.setup.outputs.push_images == 'true' }}
          # Note: 'latest' tag is server-side maintained by KX Downloads
          tags: ${{ needs.setup.outputs.registry }}/${{ env.INGESTOR_SERVER_IMAGE }}:${{ needs.setup.outputs.version }}
          labels: |
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.version=${{ needs.setup.outputs.version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

  # Build Frontend
  build-frontend:
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to KX Downloads Registry (Dev)
        if: needs.setup.outputs.push_images == 'true' && needs.setup.outputs.environment == 'dev'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DEV_REGISTRY }}
          username: ${{ secrets.KX_DOWNLOADS_USER_DEV }}
          password: ${{ secrets.KX_DOWNLOADS_TOKEN_DEV }}

      - name: Login to KX Downloads Registry (Prod)
        if: needs.setup.outputs.push_images == 'true' && needs.setup.outputs.environment == 'prod'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.PROD_REGISTRY }}
          username: ${{ secrets.KX_DOWNLOADS_USER_PROD }}
          password: ${{ secrets.KX_DOWNLOADS_TOKEN_PROD }}

      - name: Build and push Frontend
        uses: docker/build-push-action@v5
        with:
          context: ${{ env.BLUEPRINT_DIR }}/frontend
          file: ${{ env.BLUEPRINT_DIR }}/frontend/Dockerfile
          push: ${{ needs.setup.outputs.push_images == 'true' }}
          # Note: 'latest' tag is server-side maintained by KX Downloads
          tags: ${{ needs.setup.outputs.registry }}/${{ env.FRONTEND_IMAGE }}:${{ needs.setup.outputs.version }}
          labels: |
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.version=${{ needs.setup.outputs.version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64
          build-args: |
            VITE_API_CHAT_URL=http://rag-server:8081/v1
            VITE_API_VDB_URL=http://ingestor-server:8082/v1

  # Summary job
  summary:
    runs-on: ubuntu-latest
    needs: [setup, build-rag-server, build-ingestor-server, build-frontend]
    if: always()
    steps:
      - name: Build Summary
        run: |
          echo "## KX-NVIDIA RAG Blueprint - Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Registry | \`${{ needs.setup.outputs.registry }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | \`${{ needs.setup.outputs.environment }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | \`${{ needs.setup.outputs.version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Prerelease | ${{ needs.setup.outputs.is_prerelease }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Push Images | ${{ needs.setup.outputs.push_images }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.setup.outputs.push_images }}" == "true" ]]; then
            echo "### Images Pushed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Image | Status |" >> $GITHUB_STEP_SUMMARY
            echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
            echo "| \`${{ needs.setup.outputs.registry }}/${{ env.RAG_SERVER_IMAGE }}:${{ needs.setup.outputs.version }}\` | ${{ needs.build-rag-server.result }} |" >> $GITHUB_STEP_SUMMARY
            echo "| \`${{ needs.setup.outputs.registry }}/${{ env.INGESTOR_SERVER_IMAGE }}:${{ needs.setup.outputs.version }}\` | ${{ needs.build-ingestor-server.result }} |" >> $GITHUB_STEP_SUMMARY
            echo "| \`${{ needs.setup.outputs.registry }}/${{ env.FRONTEND_IMAGE }}:${{ needs.setup.outputs.version }}\` | ${{ needs.build-frontend.result }} |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "> **Note:** The \`latest\` tag is automatically managed by KX Downloads portal" >> $GITHUB_STEP_SUMMARY
          else
            echo "### Images Built (not pushed)" >> $GITHUB_STEP_SUMMARY
            echo "- \`${{ env.RAG_SERVER_IMAGE }}:${{ needs.setup.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`${{ env.INGESTOR_SERVER_IMAGE }}:${{ needs.setup.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`${{ env.FRONTEND_IMAGE }}:${{ needs.setup.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Support: #downloads-portal-help or download-portal-help@kx.com*" >> $GITHUB_STEP_SUMMARY
